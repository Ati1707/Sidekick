@using Sidekick.Apis.Poe.Bulk;
@using Sidekick.Apis.Poe.Trade.Models
@using Sidekick.Common.Game.Items
@using Sidekick.Common.Settings
@using Sidekick.Modules.Trade.Localization
@using Sidekick.Modules.Trade.Components.Prices

@if (PriceCheckService.Item == null)
{
    return;
}

<div class="flex flex-col h-full">
    <div>
        <ItemHeader Name="@PriceCheckService.Item.Header.Name"
                    Type="@PriceCheckService.Item.Header.Type"
                    Rarity="PriceCheckService.Item.Metadata.Rarity"
                    Influences="PriceCheckService.Item.Influences"/>
    </div>

    <div class="grow overflow-y-auto pb-8">
        <SidekickErrorBoundary>
            <PriceNinjaComponent/>
        </SidekickErrorBoundary>
        <SidekickErrorBoundary>
            <PricePredictionComponent/>
        </SidekickErrorBoundary>

        @if (PriceCheckService.PropertyFilters != null)
        {
            <ClassFilter/>

            @RenderPropertyFilters(PriceCheckService.PropertyFilters.Armour)
            @RenderPropertyFilters(PriceCheckService.PropertyFilters.Weapon)
            @RenderPropertyFilters(PriceCheckService.PropertyFilters.Map)
            @RenderPropertyFilters(PriceCheckService.PropertyFilters.Misc)
        }

        <ModifierFiltersComponent/>
        <PseudoFiltersComponent/>
    </div>

    @if (PriceCheckService.ShowSearchButton)
    {
        <div class="flex flex-col items-stretch text-center py-1 px-2">
            <ButtonPrimary OnClick="PriceCheckService.Search">@Resources["Search"]</ButtonPrimary>
        </div>
    }
</div>

@inject IStringLocalizer<TradeResources> Resources
@inject ISettingsService SettingsService
@inject IBulkTradeService BulkTradeService
@inject PriceCheckService PriceCheckService

@code {

    private bool HasAnyFilter { get; set; }

    private RenderFragment RenderPropertyFilters(List<PropertyFilter> filters) => @<div>
                                                                                      @foreach (var filter in filters)
                                                                                      {
                                                                                          <PropertyFilterComponent Filter="filter"/>
                                                                                      }

                                                                                      @if (filters.Count > 0)
                                                                                      {
                                                                                          <ItemSeparator Rarity="PriceCheckService.Item?.Metadata.Rarity ?? Rarity.Unknown"/>
                                                                                      }
                                                                                  </div>;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        var propertyCount = 0;
        propertyCount += PriceCheckService.PropertyFilters?.Armour.Count ?? 0;
        propertyCount += PriceCheckService.PropertyFilters?.Map.Count ?? 0;
        propertyCount += PriceCheckService.PropertyFilters?.Misc.Count ?? 0;
        propertyCount += PriceCheckService.PropertyFilters?.Weapon.Count ?? 0;

        var modifierCount = 0;
        modifierCount += PriceCheckService.ModifierFilters.Count;

        HasAnyFilter = modifierCount + propertyCount > 0;
    }

}
