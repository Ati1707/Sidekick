@using MudBlazor
@using Sidekick.Apis.PoePriceInfo
@using Sidekick.Apis.PoePriceInfo.Models
@using Sidekick.Common.Game.Items
@using Sidekick.Common.Settings
@using Sidekick.Modules.Trade.Localization

@if (Loading)
{
    <MudSkeleton Height="56px"/>
    <ItemSeparator Rarity="Item.Metadata.Rarity"/>
}
else if (Prediction != null && (Prediction.Min != 0 || Prediction.Max != 0))
{
    <MudGrid Spacing="0" Justify="Justify.Center" Class="align-start py-2">
        <MudItem xs="6" Class="pr-2">
            <MudText Typo="Typo.subtitle2" Align="Align.Right">@Resources.Prediction</MudText>
            <MudText Typo="Typo.caption" Align="Align.Right" Style="@($"color: {GetConfidenceColor()};")" Class="d-block">@Resources.PredictionConfidence(Prediction.ConfidenceScore)</MudText>
        </MudItem>
        <MudItem xs="6" Class="pl-2">
            <PriceRangeDisplay Min="Prediction.Min" Max="Prediction.Max" Currency="@Prediction.Currency" Class="justify-start"/>
        </MudItem>
    </MudGrid>
    <ItemSeparator Rarity="Item.Metadata.Rarity"/>
}

@inject TradeResources Resources
@inject ISettingsService SettingsService
@inject IPoePriceInfoClient Client

@code {

    [CascadingParameter]
    public required Item Item { get; set; }

    private bool Loading { get; set; }

    private PricePrediction? Prediction { get; set; }

    private string GetConfidenceColor()
    {
        return Prediction?.ConfidenceScore switch
        {
            (< 33) => Colors.Red.Default,
            (< 66) => Colors.Yellow.Default,
            _ => Colors.Green.Default
        };
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();

        if (!await SettingsService.GetBool(SettingKeys.PriceCheckPredictionEnabled))
        {
            return;
        }

        Loading = true;
        StateHasChanged();

        Prediction = await Client.GetPricePrediction(Item);
        Loading = false;
        StateHasChanged();
    }
}
